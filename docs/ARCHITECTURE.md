# ğŸ— ç³»çµ±æ¶æ§‹èªªæ˜ (System Architecture)

æœ¬æ–‡ä»¶æè¿° **High Society** å°ˆæ¡ˆçš„æ•´é«”è¨­è¨ˆæ¶æ§‹ã€æµé‡èµ°å‹¢ä»¥åŠæ ¸å¿ƒæŠ€è¡“æ±ºç­–ã€‚

---

## 1. å…¨æ™¯æ¶æ§‹åœ– (System Overview)

æœ¬å°ˆæ¡ˆæ¡ç”¨ **ã€Œå–®ä¸€å…¥å£ä¼ºæœå™¨ã€** æ¶æ§‹ï¼Œæ‰€æœ‰éœæ…‹è³‡æºèˆ‡ WebSocket é€šè¨Šçš†é€éåŒä¸€å€‹ç¶²åŸŸæœå‹™ã€‚

```mermaid
graph TD
    User([ç©å®¶ Discord å®¢æˆ¶ç«¯]) -- "HTTPS/WSS (Port 443)" --> CF[Cloudflare CDN & Proxy]
    CF -- "æµé‡è½‰ç™¼" --> KP[Kamal Proxy]

    subgraph VM [é›²ç«¯ä¸»æ©Ÿ VPS]
        KP -- "æ ¹æ“š Host æ¨™é ­è½‰ç™¼" --> App[Stoa éŠæˆ²å®¹å™¨]

        subgraph App [éŠæˆ²å®¹å™¨ - Option A æ‰“åŒ…]
            Node[Node.js æ¬Šå¨ä¼ºæœå™¨]
            Vue[Vue 3 éœæ…‹è³‡æº]
            Node -- "è¨—ç®¡" --> Vue
        end

        App -- "Docker å…§ç¶² (5432)" --> DB[(PostgreSQL Accessory)]
    end

```

---

## 2. æ ¸å¿ƒæ±ºç­–ï¼šåˆé«”æ‰“åŒ… (Option A)

ç‚ºäº†ç°¡åŒ–éƒ¨ç½²ä¸¦è§£æ±º Discord Activity åš´æ ¼çš„è·¨ç¶²åŸŸé™åˆ¶ï¼Œæˆ‘å€‘é¸æ“‡å°‡å‰ç«¯èˆ‡å¾Œç«¯æ‰“åŒ…åœ¨åŒä¸€å€‹ Docker æ˜ åƒæª”ä¸­ã€‚

### **ç‚ºä½•é¸æ“‡æ­¤æ–¹æ¡ˆï¼Ÿ**

1. **å¾¹åº•è§£æ±º CORS å•é¡Œ**ï¼šå‰ç«¯èˆ‡å¾Œç«¯åŒæº (Same-Origin)ï¼Œä¸éœ€è™•ç†è¤‡é›œçš„è·¨åŸŸæ¨™é ­ã€‚
2. **å–®ä¸€ç¶²åŸŸç®¡ç†**ï¼šåªéœ€è¦ç¶­è­·ä¸€å€‹ç¶²åŸŸ (`game.miao-bao.cc`)ï¼Œç°¡åŒ– SSL æ†‘è­‰èˆ‡ Cloudflare è¨­å®šã€‚
3. **Discord å‹å–„**ï¼šDiscord çš„ iframe å°å¤–éƒ¨è³‡æºæœ‰åš´æ ¼çš„ CSP é™åˆ¶ï¼Œå–®ä¸€å…¥å£èƒ½å¤§å¹…æ¸›å°‘åœ¨ Discord Developer Portal çš„è¨­å®šè² æ“”ã€‚

---

## 3. é—œéµçµ„ä»¶èªªæ˜

### **A. å‰ç«¯ï¼šVue 3 + Discord SDK**

- **è§’è‰²**ï¼šè² è²¬æ¸²æŸ“éŠæˆ² UI èˆ‡æ¥æ”¶ä½¿ç”¨è€…æ“ä½œã€‚
- **é€šè¨Š**ï¼šé€éç›¸å°è·¯å¾‘é€£æ¥ WebSocket (`io()`) èˆ‡ APIã€‚
- **å®‰å…¨æ€§**ï¼šä¸å„²å­˜æ•æ„Ÿé‚è¼¯ï¼Œæ‰€æœ‰å‹•ä½œçš†éœ€ç¶“éå¾Œç«¯é©—è­‰ã€‚

### **B. å¾Œç«¯ï¼šNode.js æ¬Šå¨ä¼ºæœå™¨**

- **è§’è‰²**ï¼šå”¯ä¸€çš„çœŸç†ä¾†æº (Source of Truth)ã€‚è² è²¬é©—è­‰å‹•ä½œã€ç¶­è­·ç‹€æ…‹æ©Ÿã€ä¸¦è¨—ç®¡å‰ç«¯éœæ…‹æª”æ¡ˆã€‚
- **éœæ…‹æª”æ¡ˆè¨—ç®¡**ï¼šä½¿ç”¨ `express.static` è¨—ç®¡ç”± Vite ç·¨è­¯ç”¢å‡ºçš„ `dist` è³‡æ–™å¤¾ã€‚
- **å®‰å…¨æ€§**ï¼šå¿…é ˆæ ¡é©— Discord å‚³ä¾†çš„ `auth token`ï¼Œç¢ºä¿ä½¿ç”¨è€…èº«åˆ†çœŸå¯¦æ€§ã€‚

### **C. è³‡æ–™åº«ï¼šPostgreSQL**

- **è§’è‰²**ï¼šæŒä¹…åŒ–å„²å­˜å°å±€ç‹€æ…‹ã€ç©å®¶è³‡æ–™èˆ‡æˆ¿é–“è³‡è¨Šã€‚
- **éƒ¨ç½²**ï¼šä½œç‚º Kamal çš„ **Accessory** é‹è¡Œï¼Œç¨ç«‹æ–¼æ‡‰ç”¨ç¨‹å¼å®¹å™¨ä½†ä½æ–¼åŒä¸€å° VMï¼Œé€é Docker å…§ç¶²æºé€šã€‚

### **D. åŸºç¤è¨­æ–½ï¼šKamal 2 & Cloudflare**

- **Cloudflare**ï¼šé–‹å•Ÿã€Œæ©˜è‰²é›²æœµã€æ¨¡å¼ï¼Œæä¾›è‡ªå‹• CDN å¿«å–ï¼ˆé‡å°åœ–ç‰‡ã€JS/CSSï¼‰èˆ‡ DDoS é˜²è­·ã€‚
- **Kamal Proxy**ï¼šä½œç‚ºä¸»æ©Ÿçš„å…¥å£ï¼Œè² è²¬è™•ç†é›¶åœæ©Ÿéƒ¨ç½²æ™‚çš„æµé‡åˆ‡æ› (Zero-downtime rolling restart)ã€‚

---

## 4. è³‡æ–™æµå‘ (Data Flow)

### **éŠæˆ²å•Ÿå‹•æµ (Init Flow)**

1. ç©å®¶åœ¨ Discord é–‹å•Ÿ Activityã€‚
2. Discord å‘ `game.miao-bao.cc` è¦æ±‚ `index.html`ã€‚
3. Cloudflare å‘½ä¸­å¿«å–ï¼ˆæˆ–æ˜¯å‘ Node.js è«‹æ±‚ï¼‰ï¼Œå›å‚³éœæ…‹è³‡æºã€‚
4. å‰ç«¯åˆå§‹åŒ– Discord SDK ä¸¦å–å¾—èªè­‰è³‡è¨Šã€‚

### **å°å±€å‹•ä½œæµ (Game Action Flow)**

1. ç©å®¶é»æ“Šã€Œå‡ºåƒ¹ã€ã€‚
2. å‰ç«¯é€é WebSocket ç™¼é€å°åŒ…ã€‚
3. Node.js æ¥æ”¶å°åŒ…ï¼Œå•Ÿå‹• **PostgreSQL äº‹å‹™ (Transaction)**ã€‚
4. æª¢æŸ¥æ˜¯å¦ç‚ºè©²ç©å®¶å›åˆ æ‰£é™¤é‡‘é¡ æ›´æ–°æœ€é«˜å‡ºåƒ¹ã€‚
5. Node.js å»£æ’­æ›´æ–°å¾Œçš„ç‹€æ…‹çµ¦æˆ¿é–“å…§æ‰€æœ‰ç©å®¶ã€‚

---

## 5. å®‰å…¨æ€§è€ƒé‡ (Security)

- **Content Security Policy (CSP)**ï¼šå¾Œç«¯å¿…é ˆæ˜ç¢ºå®£å‘Š `frame-ancestors https://discord.com`ï¼Œå¦å‰‡ Discord æœƒé˜»æ“‹ iframe è¼‰å…¥ã€‚
- **éš±è—çœŸå¯¦ IP**ï¼šé€é Cloudflare Proxy éš±è—ä¼ºæœå™¨çœŸå¯¦ IPã€‚
- **å…§ç¶²éš”é›¢**ï¼šPostgreSQL ä¸å°å¤–é–‹æ”¾ Portï¼Œåƒ…å…è¨±æ‡‰ç”¨ç¨‹å¼å®¹å™¨å­˜å–ã€‚

---

> **ç›¸é—œæ±ºç­–ç´€éŒ„ (ADR):**
>
> - [ADR-0001: é¸æ“‡åˆé«”æ‰“åŒ…æ–¹æ¡ˆ](https://www.google.com/search?q=./adr/0001-initial-architecture.md)
> - [ADR-0002: ä½¿ç”¨ PostgreSQL æ›¿ä»£ Redis è™•ç†å›åˆç‹€æ…‹](https://www.google.com/search?q=./adr/0002-postgresql-state-machine.md)
