這是一份為你的新專案整理的「上流社會 Discord Activity」需求與技術規劃說明書。這份文件專注於架構設計與決策邏輯，適合開發前作為全局參考。

---

# 專案需求說明書：上流社會 (High Society) Discord Activity

## 1. 專案目標

實作一款基於 Discord Activity 平台的回合制策略桌遊《上流社會》。透過 Discord 嵌入式環境，提供語音頻道內的玩家即時競標、心理博弈與社交互動體驗。

## 2. 技術選型 (Tech Stack)

| 組件 | 選用技術 | 選用理由 |
| --- | --- | --- |
| **前端框架** | **Vue 3** | 響應式狀態管理，適合處理複雜的遊戲 UI 變換與卡牌動畫。 |
| **後端運行環境** | **Node.js (Express)** | 與 Socket.io 整合度最高，非同步 I/O 特性適合處理大量並發的長連接。 |
| **即時通訊** | **Socket.io** | 支援 WebSocket 與長輪詢回退，內建房間 (Room) 管理與斷線重連機制。 |
| **資料庫** | **PostgreSQL (Prisma ORM)** | 儲存遊戲狀態（JSONB）、玩家數據、勝率統計與對局歷史紀錄，確保資料完整性與伺服器重啟後狀態不丟失。 |
| **部署工具** | **Kamal 2** | 基於 Docker 容器化的部署方案，支援零停機更新與自動化運維。 |
| **反向代理 / 入口** | **Kamal Proxy** | 支援單機多應用並存，處理 **TLS 終止**與 WebSocket 轉發。 |

---

## 3. 核心設計決策與理由

### A. 網路架構：多服務並存與 TLS 終止

* **決策：** 使用 **Kamal Proxy** 作為唯一 80/443 入口，並透過 **CNAME** 定義子網域。
* **理由：** 解決主機上已有服務 (`fizzy`) 的埠口衝突。透過 Proxy 統一處理 Let's Encrypt 憑證，後端 Node.js 僅需運行 HTTP 協定，簡化憑證管理成本並降低 CPU 加解密負擔。

### B. 遊戲狀態管理：單一事實來源 (SSOT)

* **決策：** 採用 **Authoritative Server (權威伺服器)** 模式，所有遊戲邏輯判定皆在後端完成。
* **理由：** 防止客戶端竄改金額或非法出價。前端僅作為狀態的「投影」，所有動作必須經由後端驗證後，更新至資料庫，再廣播給所有玩家。

### C. 狀態持久化：PostgreSQL JSONB

* **決策：** 使用 PostgreSQL 的 JSONB 欄位儲存進行中的遊戲狀態。
* **理由：** 單一資料庫同時處理熱狀態與歷史紀錄，簡化架構。伺服器重啟後遊戲狀態不丟失。Node.js 單執行緒特性已能處理回合制遊戲的併發需求。

### D. 房間隔離：Discord Instance ID

* **決策：** 以 Discord 提供之 `activity_instance_id` 作為 Socket.io 的 `Room ID`。
* **理由：** 自然對應 Discord 語音頻道。不同頻道的玩家會被物理隔絕在不同的遊戲實例中，互不干擾。

---

## 4. 遊戲邏輯關鍵流程

1. **初始化 (Handshake)**：
* 玩家透過 Discord OAuth2 認證進入遊戲。
* Server 確認玩家身分並將其加入對應的 Socket Room。


2. **拍賣階段 (Auction Loop)**：
* **正向拍賣**：追逐高分，最後留下來的人付錢。
* **反向拍賣**：避開災厄，第一個放棄 (Pass) 的人收牌，其他人付錢。


3. **狀態同步**：
* 每次有效的 `BID` 或 `PASS` 動作後，Server 推送完整的 `GameStateSnapshot`。
* 資料過濾：發送給特定玩家的封包中，需隱藏其他玩家的手牌面額細節（僅顯示張數）。


4. **結算與持久化**：
* 偵測第 4 張紅框卡，強制中斷。
* 判定「最窮者失格」，計算剩餘玩家總分。
* 將結果寫入 PostgreSQL。



---

## 5. 注意事項與潛在坑點

* **Sticky Sessions (黏性連線)**：
雖目前為單機架構，但未來若擴展為多台伺服器，需確保 Socket.io 使用 Redis Adapter，否則不同容器間無法進行廣播。
* **斷線重連機制**：
Discord 嵌入式環境中容易因手機螢幕熄滅或切換 App 導致 Socket 斷開。必須實作「重連後狀態回填」，讓玩家回到遊戲後能立刻同步當前進度。
* **不可找零限制**：
前端 UI 必須嚴格限制玩家選牌，若所選卡片面額總計無法超過當前最高價，需給予提示並禁用提交按鈕。
* **Cloudflare SSL 設定**：
若使用 Cloudflare 代理，務必將 SSL 模式設為 **Full (Strict)**，避免與 Kamal Proxy 自帶的 HTTPS 產生重新導向迴圈。
* **垃圾話空間 (Social Aspect)**：
Discord Activity 的核心價值是社交。UI 設計應留出足夠空間顯示玩家頭像與出價動態，甚至可加入簡單的動態貼圖互動。

---

這份說明書涵蓋了從網路層到邏輯層的完整規劃。
